# API_COMMON_é€šç”¨è§„èŒƒ

## æ–‡æ¡£å±¥å†

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹äºº | ä¿®æ”¹å†…å®¹ | å®¡æ ¸çŠ¶æ€ |
|------|------|--------|----------|----------|
| v1.0 | 2026-02-03 | BEå·¥ç¨‹å¸ˆ | åˆå§‹ç‰ˆæœ¬ï¼Œç»Ÿä¸€APIé€šç”¨è§„èŒƒ | ğŸ”„ å¾…å®¡æ ¸ |

---

## 1. APIè®¾è®¡è§„èŒƒ

### 1.1 RESTfulè®¾è®¡åŸåˆ™

- **èµ„æºå‘½å**: ä½¿ç”¨åè¯å¤æ•°å½¢å¼ï¼Œå¦‚ `/vms`, `/users`, `/alerts`
- **HTTPæ–¹æ³•**: 
  - `GET` - è·å–èµ„æº
  - `POST` - åˆ›å»ºèµ„æº
  - `PUT` - æ›´æ–°èµ„æºï¼ˆå®Œæ•´æ›´æ–°ï¼‰
  - `PATCH` - éƒ¨åˆ†æ›´æ–°èµ„æº
  - `DELETE` - åˆ é™¤èµ„æº
- **ç‰ˆæœ¬æ§åˆ¶**: URLè·¯å¾„ä¸­åŒ…å«ç‰ˆæœ¬å·ï¼Œå¦‚ `/api/v1/`
- **åµŒå¥—èµ„æº**: ä½¿ç”¨å±‚çº§è·¯å¾„è¡¨ç¤ºå…³ç³»ï¼Œå¦‚ `/vms/{id}/alerts`

### 1.2 URLè®¾è®¡è§„èŒƒ

```
/api/v1/{resource}              # èµ„æºåˆ—è¡¨
/api/v1/{resource}/{id}         # å•ä¸ªèµ„æº
/api/v1/{resource}/{id}/{sub}   # å­èµ„æº
/api/v1/{resource}/batch         # æ‰¹é‡æ“ä½œ
/api/v1/{resource}/search        # æœç´¢æ“ä½œ
/api/v1/{resource}/export        # å¯¼å‡ºæ“ä½œ
/api/v1/{resource}/import        # å¯¼å…¥æ“ä½œ
/api/v1/{resource}/statistics    # ç»Ÿè®¡æ•°æ®
/api/v1/{resource}/sync          # åŒæ­¥æ“ä½œ
```

---

## 2. è¯·æ±‚è§„èŒƒ

### 2.1 è¯·æ±‚å¤´

| å¤´éƒ¨å­—æ®µ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|------|
| `Authorization` | æ˜¯ | Bearer Tokenè®¤è¯ | `Bearer eyJhbGci...` |
| `Content-Type` | POST/PUTæ—¶ | è¯·æ±‚ä½“æ ¼å¼ | `application/json` |
| `Accept-Language` | å¦ | è¯­è¨€åå¥½ | `zh-CN`, `en`, `ja-JP` |
| `X-Request-ID` | å¦ | è¯·æ±‚è¿½è¸ªID | `req_20260203_001` |
| `X-Client-Version` | å¦ | å®¢æˆ·ç«¯ç‰ˆæœ¬ | `web-v1.0.0` |

### 2.2 æŸ¥è¯¢å‚æ•°è§„èŒƒ

#### åˆ†é¡µå‚æ•°
```
?page=1&pageSize=20
```

#### æ’åºå‚æ•°
```
&sortBy=name&sortOrder=asc        # asc æˆ– desc
```

#### ç­›é€‰å‚æ•°
```
&status=online&os=Linux&groupId=grp_001
```

#### æ—¶é—´èŒƒå›´å‚æ•°
```
&startTime=2026-02-01T00:00:00Z&endTime=2026-02-03T23:59:59Z
```

#### æœç´¢å‚æ•°
```
&keyword=web-server
```

### 2.3 è¯·æ±‚ä½“æ ¼å¼

æ‰€æœ‰POST/PUTè¯·æ±‚ä½¿ç”¨JSONæ ¼å¼ï¼š

```json
{
  "field1": "value1",
  "field2": 123,
  "field3": true,
  "nested": {
    "subField": "value"
  },
  "array": ["item1", "item2"]
}
```

---

## 3. å“åº”è§„èŒƒ

### 3.1 ç»Ÿä¸€å“åº”æ ¼å¼

```typescript
interface ApiResponse<T> {
  code: number;                     // ä¸šåŠ¡çŠ¶æ€ç 
  message: string;                  // å“åº”æ¶ˆæ¯
  data: T;                          // å“åº”æ•°æ®
  traceId?: string;                 // è¿½è¸ªIDï¼ˆç”¨äºé—®é¢˜æ’æŸ¥ï¼‰
  timestamp: string;                // å“åº”æ—¶é—´æˆ³ï¼ˆISO 8601ï¼‰
}
```

### 3.2 æˆåŠŸå“åº”

**å•æ¡æ•°æ® (200)**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": { ... },
  "timestamp": "2026-02-03T14:30:00Z"
}
```

**åˆ—è¡¨æ•°æ® (200)**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "list": [ ... ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 150,
      "totalPages": 8
    }
  },
  "timestamp": "2026-02-03T14:30:00Z"
}
```

**åˆ›å»ºæˆåŠŸ (201)**
```json
{
  "code": 201,
  "message": "åˆ›å»ºæˆåŠŸ",
  "data": { ... },
  "timestamp": "2026-02-03T14:30:00Z"
}
```

**å¼‚æ­¥ä»»åŠ¡ (202)**
```json
{
  "code": 202,
  "message": "ä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "taskId": "task_001",
    "status": "pending"
  },
  "timestamp": "2026-02-03T14:30:00Z"
}
```

**æ— å†…å®¹ (204)**
- å“åº”ä½“ä¸ºç©º

### 3.3 é”™è¯¯å“åº”

```json
{
  "code": 400,
  "message": "è¯·æ±‚å‚æ•°é”™è¯¯",
  "data": {
    "errors": [
      {
        "field": "email",
        "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
      }
    ]
  },
  "traceId": "trace_20260203_001",
  "timestamp": "2026-02-03T14:30:00Z"
}
```

---

## 4. HTTPçŠ¶æ€ç 

### 4.1 çŠ¶æ€ç ä½¿ç”¨è§„èŒƒ

| çŠ¶æ€ç  | ä½¿ç”¨åœºæ™¯ | è¯´æ˜ |
|--------|---------|------|
| `200 OK` | è¯·æ±‚æˆåŠŸ | æ­£å¸¸è¿”å›æ•°æ® |
| `201 Created` | åˆ›å»ºæˆåŠŸ | èµ„æºåˆ›å»ºæˆåŠŸ |
| `202 Accepted` | å·²æ¥å— | å¼‚æ­¥ä»»åŠ¡å·²åˆ›å»º |
| `204 No Content` | æ— å†…å®¹ | åˆ é™¤æˆåŠŸæˆ–æ— æ•°æ® |
| `400 Bad Request` | è¯·æ±‚é”™è¯¯ | å‚æ•°ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯ |
| `401 Unauthorized` | æœªè®¤è¯ | Tokenæ— æ•ˆæˆ–è¿‡æœŸ |
| `403 Forbidden` | æ— æƒé™ | æƒé™ä¸è¶³ |
| `404 Not Found` | ä¸å­˜åœ¨ | èµ„æºä¸å­˜åœ¨ |
| `409 Conflict` | å†²çª | æ•°æ®å†²çªï¼ˆå¦‚é‡å¤ï¼‰ |
| `422 Unprocessable Entity` | æ— æ³•å¤„ç† | ä¸šåŠ¡é€»è¾‘é”™è¯¯ |
| `429 Too Many Requests` | é¢‘ç‡é™åˆ¶ | è¯·æ±‚è¿‡äºé¢‘ç¹ |
| `500 Internal Server Error` | æœåŠ¡å™¨é”™è¯¯ | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| `503 Service Unavailable` | æœåŠ¡ä¸å¯ç”¨ | æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ |

### 4.2 ä¸šåŠ¡çŠ¶æ€ç 

HTTPçŠ¶æ€ç åŸºç¡€ä¸Šï¼Œä½¿ç”¨ä¸šåŠ¡çŠ¶æ€ç ç»†åŒ–é”™è¯¯ç±»å‹ï¼š

**é€šç”¨é”™è¯¯ (400-499)**
- `400` - é€šç”¨å‚æ•°é”™è¯¯
- `400-VALIDATION` - æ•°æ®éªŒè¯é”™è¯¯
- `400-FORMAT` - æ ¼å¼é”™è¯¯
- `400-TIME` - æ—¶é—´èŒƒå›´é”™è¯¯
- `400-LIMIT` - è¶…å‡ºé™åˆ¶
- `401` - è®¤è¯å¤±è´¥
- `401-EXPIRED` - Tokenè¿‡æœŸ
- `401-INVALID` - Tokenæ— æ•ˆ
- `403` - æƒé™ä¸è¶³
- `403-LOCKED` - è´¦æˆ·é”å®š
- `403-EXPIRED` - è´¦æˆ·è¿‡æœŸ
- `404` - èµ„æºä¸å­˜åœ¨
- `409` - æ•°æ®å†²çª
- `422` - ä¸šåŠ¡é€»è¾‘é”™è¯¯
- `429` - é¢‘ç‡é™åˆ¶

**ç³»ç»Ÿé”™è¯¯ (500-599)**
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- `503` - æœåŠ¡ä¸å¯ç”¨
- `503-DB` - æ•°æ®åº“ä¸å¯ç”¨
- `503-CACHE` - ç¼“å­˜æœåŠ¡ä¸å¯ç”¨
- `503-EXTERNAL` - å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨

---

## 5. åˆ†é¡µè§„èŒƒ

### 5.1 è¯·æ±‚å‚æ•°

```
?page=1&pageSize=20
```

- `page`: é¡µç ï¼Œä»1å¼€å§‹
- `pageSize`: æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20ï¼Œæœ€å¤§1000

### 5.2 å“åº”æ ¼å¼

```json
{
  "list": [...],
  "pagination": {
    "page": 1,                    // å½“å‰é¡µç 
    "pageSize": 20,               // æ¯é¡µæ•°é‡
    "total": 150,                 // æ€»è®°å½•æ•°
    "totalPages": 8               // æ€»é¡µæ•°
  }
}
```

### 5.3 æ¸¸æ ‡åˆ†é¡µï¼ˆå¤§æ•°æ®é‡åœºæ™¯ï¼‰

é€‚ç”¨äºå¯¼å‡ºã€æ—¥å¿—æŸ¥è¯¢ç­‰å¤§æ•°æ®é‡åœºæ™¯ï¼š

**è¯·æ±‚**
```
?cursor=eyJpZCI6MTAwMCwiY3JlYXRlZEF0IjoiMjAyNi0wMi0wMyJ9&limit=1000
```

**å“åº”**
```json
{
  "list": [...],
  "pagination": {
    "cursor": "eyJpZCI6MTAwMCwiY3JlYXRlZEF0IjoiMjAyNi0wMi0wMyJ9",
    "nextCursor": "eyJpZCI6MjAwMCwiY3JlYXRlZEF0IjoiMjAyNi0wMi0wMyJ9",
    "hasMore": true,
    "limit": 1000
  }
}
```

---

## 6. æ—¶é—´æ ¼å¼è§„èŒƒ

### 6.1 æ ‡å‡†æ ¼å¼

æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ **ISO 8601** æ ¼å¼ï¼š

```
2026-02-03T14:30:00Z           // UTCæ—¶é—´ï¼ˆå¸¦Zï¼‰
2026-02-03T14:30:00+08:00      // å¸¦æ—¶åŒºåç§»
```

### 6.2 æ—¥æœŸèŒƒå›´æŸ¥è¯¢

```
?startTime=2026-02-01T00:00:00Z&endTime=2026-02-03T23:59:59Z
```

### 6.3 æ—¶åŒºå¤„ç†

- æœåŠ¡å™¨å­˜å‚¨ï¼šç»Ÿä¸€ä½¿ç”¨UTC
- APIä¼ è¾“ï¼šç»Ÿä¸€ä½¿ç”¨UTCï¼ˆå¸¦Zåç¼€ï¼‰
- å‰ç«¯æ˜¾ç¤ºï¼šæ ¹æ®ç”¨æˆ·åå¥½æ—¶åŒºè½¬æ¢

---

## 7. é”™è¯¯æ¶ˆæ¯è§„èŒƒ

### 7.1 æ¶ˆæ¯æ ¼å¼

```json
{
  "code": 400,
  "message": "è¯·æ±‚å‚æ•°é”™è¯¯",
  "data": {
    "errors": [
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
      }
    ]
  }
}
```

### 7.2 å¤šè¯­è¨€æ”¯æŒ

é”™è¯¯æ¶ˆæ¯æ”¯æŒä¸‰ç§è¯­è¨€ï¼š

| è¯­è¨€ä»£ç  | è¯­è¨€ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| `en` | English | å›½é™…ç”¨æˆ·ã€é»˜è®¤ |
| `zh-CN` | ç®€ä½“ä¸­æ–‡ | ä¸­å›½ç”¨æˆ· |
| `ja-JP` | æ—¥æœ¬èª | æ—¥æœ¬ç”¨æˆ· |

**ä¼˜å…ˆçº§**
1. è¯·æ±‚ä¸­ `Accept-Language` Header
2. ç”¨æˆ·ä¸ªäººè®¾ç½®ä¸­çš„è¯­è¨€åå¥½
3. é»˜è®¤è¯­è¨€ï¼ˆ`en`ï¼‰

---

## 8. è®¤è¯è§„èŒƒ

### 8.1 Tokenè®¤è¯

ä½¿ç”¨ **JWT (JSON Web Token)** è¿›è¡Œè®¤è¯ï¼š

**è¯·æ±‚å¤´**
```
Authorization: Bearer {access_token}
```

**Tokenç±»å‹**
- `Access Token`: ç”¨äºAPIè®¿é—®ï¼Œæœ‰æ•ˆæœŸ1å°æ—¶
- `Refresh Token`: ç”¨äºåˆ·æ–°Access Tokenï¼Œæœ‰æ•ˆæœŸ7å¤©ï¼ˆè®°ä½æˆ‘30å¤©ï¼‰

### 8.2 Tokenåˆ·æ–°

```
POST /api/v1/auth/refresh
Authorization: Bearer {refresh_token}
```

### 8.3 æƒé™æ§åˆ¶

åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼š

**æƒé™ä»£ç æ ¼å¼**
```
{resource}:{action}
```

ç¤ºä¾‹ï¼š
- `vm:read` - æŸ¥çœ‹VM
- `vm:write` - ç¼–è¾‘VM
- `alert:admin` - å‘Šè­¦ç®¡ç†
- `system:admin` - ç³»ç»Ÿç®¡ç†

---

## 9. æ€§èƒ½è§„èŒƒ

### 9.1 å“åº”æ—¶é—´ç›®æ ‡

| æ¥å£ç±»å‹ | P50ç›®æ ‡ | P95ç›®æ ‡ | P99ç›®æ ‡ |
|---------|---------|---------|---------|
| ç®€å•æŸ¥è¯¢ | < 100ms | < 200ms | < 500ms |
| å¤æ‚æŸ¥è¯¢ | < 300ms | < 500ms | < 1s |
| åˆ—è¡¨æŸ¥è¯¢ | < 200ms | < 500ms | < 1s |
| åˆ›å»º/æ›´æ–° | < 200ms | < 500ms | < 1s |
| å¯¼å‡º/æŠ¥è¡¨ | < 1s | < 3s | < 5s |

### 9.2 å¹¶å‘é™åˆ¶

- æ™®é€šæ¥å£ï¼š1000 QPS/ç”¨æˆ·
- å¯¼å‡ºæ¥å£ï¼š10 QPS/ç”¨æˆ·
- æ‰¹é‡æ“ä½œï¼š100 QPS/ç”¨æˆ·

### 9.3 å¤§æ•°æ®é‡é™åˆ¶

| åœºæ™¯ | é™åˆ¶ |
|------|------|
| åˆ—è¡¨é¡µæ¯é¡µå¤§å° | æœ€å¤§1000 |
| æ‰¹é‡æ“ä½œæ•°é‡ | æœ€å¤§100 |
| å¯¼å‡ºè®°å½•æ•° | æœ€å¤§100,000 |
| æŸ¥è¯¢æ—¶é—´èŒƒå›´ | æœ€å¤§2å¹´ |
| åŒæ—¶WebSocketè¿æ¥ | æœ€å¤§100ä¸ªVM |

---

## 10. å®‰å…¨è§„èŒƒ

### 10.1 ä¼ è¾“å®‰å…¨

- å¼ºåˆ¶HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- TLS 1.2+
- HSTSå¤´éƒ¨

### 10.2 æ•°æ®å®‰å…¨

- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- å¯†ç ä½¿ç”¨RSAå…¬é’¥åŠ å¯†ä¼ è¾“
- Tokenå®‰å…¨å­˜å‚¨ï¼ˆHttpOnly Cookieæˆ–Secure Storageï¼‰

### 10.3 é˜²æŠ¤æœºåˆ¶

- è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼ˆRate Limitingï¼‰
- CORSç™½åå•
- SQLæ³¨å…¥é˜²æŠ¤ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- XSSé˜²æŠ¤ï¼ˆè¾“å…¥è¿‡æ»¤ï¼‰
- CSRFé˜²æŠ¤ï¼ˆTokenéªŒè¯ï¼‰

---

## 11. APIå˜æ›´ç®¡ç†

### 11.1 ç‰ˆæœ¬æ§åˆ¶

- ä¸»ç‰ˆæœ¬å·ï¼šé‡å¤§å˜æ›´ï¼ˆå¦‚ `/api/v2/`ï¼‰
- æ¬¡ç‰ˆæœ¬å·ï¼šå‘åå…¼å®¹çš„åŠŸèƒ½æ–°å¢
- ä¿®è®¢å·ï¼šBugä¿®å¤

### 11.2 å˜æ›´é€šçŸ¥

- é‡å¤§å˜æ›´æå‰30å¤©é€šçŸ¥
- åºŸå¼ƒAPIä¿ç•™3ä¸ªæœˆè¿‡æ¸¡æœŸ
- å˜æ›´è®°å½•åœ¨ `api-changes.md`

### 11.3 å…¼å®¹æ€§ä¿è¯

- åŒç‰ˆæœ¬APIä¿æŒå‘åå…¼å®¹
- æ–°å¢å­—æ®µå…è®¸ä¸ºç©º
- ä¸åˆ é™¤å·²æœ‰å­—æ®µ
- ä¸ä¿®æ”¹å·²æœ‰å­—æ®µç±»å‹

---

## 12. å˜æ›´è®°å½•

### ç‰ˆæœ¬ v1.0 (2026-02-03)
**ä¿®æ”¹äºº**: BEå·¥ç¨‹å¸ˆ  
**ä¿®æ”¹åŸå› **: ç»Ÿä¸€APIé€šç”¨è§„èŒƒï¼Œä½œä¸ºæ‰€æœ‰APIæ¨¡å—çš„åŸºç¡€  
**å…·ä½“ä¿®æ”¹**:
- [x] å®šä¹‰RESTfulè®¾è®¡åŸåˆ™
- [x] å®šä¹‰URLè®¾è®¡è§„èŒƒ
- [x] å®šä¹‰è¯·æ±‚å¤´ã€æŸ¥è¯¢å‚æ•°ã€è¯·æ±‚ä½“è§„èŒƒ
- [x] å®šä¹‰ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆæˆåŠŸ/é”™è¯¯ï¼‰
- [x] å®šä¹‰HTTPçŠ¶æ€ç å’Œä¸šåŠ¡çŠ¶æ€ç 
- [x] å®šä¹‰åˆ†é¡µè§„èŒƒï¼ˆé¡µç åˆ†é¡µå’Œæ¸¸æ ‡åˆ†é¡µï¼‰
- [x] å®šä¹‰æ—¶é—´æ ¼å¼è§„èŒƒï¼ˆISO 8601ï¼‰
- [x] å®šä¹‰é”™è¯¯æ¶ˆæ¯è§„èŒƒï¼ˆå¤šè¯­è¨€æ”¯æŒï¼‰
- [x] å®šä¹‰è®¤è¯è§„èŒƒï¼ˆJWTï¼‰
- [x] å®šä¹‰æ€§èƒ½è§„èŒƒï¼ˆå“åº”æ—¶é—´ã€å¹¶å‘é™åˆ¶ï¼‰
- [x] å®šä¹‰å®‰å…¨è§„èŒƒ
- [x] å®šä¹‰APIå˜æ›´ç®¡ç†è§„èŒƒ

**å½±å“èŒƒå›´**:
- æ‰€æœ‰APIæ¨¡å—: æ˜¯ï¼ˆä½œä¸ºåŸºç¡€è§„èŒƒï¼‰
- åç«¯å¼€å‘: æ˜¯ï¼ˆå¿…é¡»éµå®ˆï¼‰
- å‰ç«¯å¼€å‘: æ˜¯ï¼ˆå¿…é¡»éµå®ˆï¼‰
- æ¥å£æ–‡æ¡£: æ˜¯ï¼ˆæ‰€æœ‰APIæ–‡æ¡£åŸºäºæ­¤è§„èŒƒï¼‰

**ç›¸å…³æ–‡æ¡£**:
- æ‰€æœ‰API_*.mdæ¨¡å—æ–‡æ¡£

---

**æ–‡æ¡£ç®¡ç†è¯´æ˜**:
1. æ­¤æ–‡æ¡£ä¸ºæ‰€æœ‰APIæ¨¡å—çš„åŸºç¡€è§„èŒƒï¼Œæ‰€æœ‰APIè®¾è®¡å¿…é¡»éµå®ˆ
2. è§„èŒƒå˜æ›´éœ€ç»è¿‡ä¸¥æ ¼è¯„å®¡ï¼Œå¹¶é€šçŸ¥æ‰€æœ‰ç›¸å…³æ–¹
3. æ–°å¢æ¨¡å—APIéœ€æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ­¤è§„èŒƒ
4. å»ºè®®å°†æ­¤è§„èŒƒçº³å…¥ä»£ç å®¡æŸ¥æ¸…å•
